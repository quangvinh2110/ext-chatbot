version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant_db
    restart: always
    ports:
      - "6333:6333" # Web UI and REST API
      - "6334:6334" # gRPC API
    volumes:
      - /Users/vinhnguyen/Projects/ext-chatbot/volumes/qdrant-storage:/qdrant/storage
    environment:
      QDRANT__STORAGE__PERFORMANCE__OPTIMIZER_CPU_BUDGET: "4" 

  infinity:
    # Use the CPU-only image variant for Macbook compatibility
    image: michaelf34/infinity:latest-cpu 
    container_name: infinity_service
    restart: always
    ports:
      # Map container port 7997 to host port 7997
      - "7997:7997" 
    volumes:
      # Cache downloaded models locally for persistence
      - /Users/vinhnguyen/Projects/ext-chatbot/volumes/embedding-cache:/app/.cache 
      - /Users/vinhnguyen/Projects/ext-chatbot/model_hub:/models
    # All settings are now passed via command line arguments
    command: >
      v2 
      --model-id /models/snowflake-arctic-embed-l-v2.0
      --port 7997 
      --engine optimum 
      --device cpu
    # Ensure Infinity starts after Qdrant
    depends_on:
      - qdrant
